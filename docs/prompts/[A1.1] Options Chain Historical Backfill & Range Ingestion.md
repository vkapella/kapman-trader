WINDSURF / CODEX — SINGLE FILE PROMPT
MODEL: GPT-5.1-Codex-Mini
MODE: Medium
SCOPE: Code modification + tests

⸻

You are operating inside the repository kapman-trader.

Your task is to implement range-based historical backfill for A1 options chain ingestion so that dealer_metrics (A3) can reliably compute metrics that require multiple prior option snapshots.

⸻

STORY CONTEXT (AUTHORITATIVE)

A1 Options Chain Ingestion currently supports:
	•	Single-day ingestion via --as-of YYYY-MM-DD
	•	Idempotent writes keyed by (time, ticker_id, expiration_date, strike_price, option_type)
	•	Snapshot identity via --snapshot-time

This is insufficient for backfilling contiguous historical windows (e.g. last 14 trading days).
Users are currently forced to run repeated one-day commands, which is error-prone and slow.

⸻

OBJECTIVE

Add first-class range ingestion support to scripts.ingest_options with:
	•	--start-date YYYY-MM-DD
	•	--end-date YYYY-MM-DD (inclusive)

This enables single-command historical backfill across multiple days while preserving:
	•	Determinism
	•	Idempotency
	•	Existing provider semantics
	•	Rate-limiting and large-symbol isolation

⸻

NON-NEGOTIABLE RULES
	1.	Range mode is syntactic sugar over daily runs
	•	Internally loop day-by-day
	•	Each day behaves exactly like --as-of <date>
	2.	Snapshot identity remains correct
	•	Each day MUST receive its own snapshot identity
	•	Default behavior:
	•	snapshot_time = <as_of_date>T23:59:59.999999Z
	•	User may still override via --snapshot-time ONLY in single-day mode
	3.	Idempotency must be preserved
	•	Re-running the same range must not duplicate rows
	•	Existing rows must be safely skipped by unique constraint
	4.	Weekends and holidays
	•	Default behavior: skip non-trading days
	•	Use existing calendar logic if present
	•	If none exists, skip Sat/Sun only (no new market-calendar dependency)
	5.	Backward compatibility
	•	Existing commands MUST continue to work unchanged
	•	--as-of and --start-date/--end-date are mutually exclusive

⸻

CLI BEHAVIOR (AUTHORITATIVE)

Valid combinations
	•	--as-of YYYY-MM-DD
	•	--start-date YYYY-MM-DD --end-date YYYY-MM-DD

Invalid combinations (must hard-fail with argparse error)
	•	--as-of with --start-date or --end-date
	•	--start-date without --end-date
	•	--end-date without --start-date

⸻

IMPLEMENTATION TASKS

1️⃣ Update CLI Argument Parsing
	•	Add --start-date
	•	Add --end-date
	•	Enforce mutual exclusivity with --as-of

2️⃣ Introduce Range Execution Wrapper
	•	In scripts/ingest_options.py:
	•	If range mode:
	•	Generate ordered list of dates (ascending)
	•	Skip weekends
	•	For each date:
	•	Invoke the existing single-day ingestion path
	•	Pass as_of=<date>
	•	Derive snapshot_time as end-of-day UTC

3️⃣ Preserve Provider Semantics
	•	Providers continue to receive:
	•	as_of=<date>
	•	No provider changes required

4️⃣ Logging & Observability

For range mode:
	•	Log at INFO:
	•	range start/end
	•	total trading days resolved
	•	For each day:
	•	Log START/END with date
	•	Preserve existing heartbeat and per-symbol logs
	•	Final summary:
	•	days attempted
	•	days succeeded
	•	days failed

5️⃣ Failure Handling
	•	Failure on one day MUST NOT abort the range
	•	Collect per-day failures
	•	Exit non-zero only if all days fail

6️⃣ Tests (Minimal but Mandatory)

Add unit tests validating:
	•	Argument exclusivity (argparse)
	•	Deterministic date expansion (weekend skip)
	•	Range invokes per-day ingestion exactly once per date
	•	Snapshot_time derivation is correct and stable

Tests may mock provider calls; do not hit real APIs.

⸻

EXPLICIT NON-GOALS
	•	No schema changes
	•	No new tables
	•	No new provider features
	•	No dealer_metrics changes
	•	No Black-Scholes or pricing logic
	•	No background jobs or schedulers

⸻

ACCEPTANCE CRITERIA
	1.	This command works and backfills cleanly:

python -m scripts.ingest_options \
  --provider polygon \
  --concurrency 6 \
  --start-date 2025-12-09 \
  --end-date 2025-12-22

	2.	Dealer metrics can compute across the backfilled window without missing-history failures.
	3.	Re-running the same command produces no duplicate rows and no errors.
	4.	Existing single-day commands remain unchanged.

⸻

DELIVERABLES
	•	Updated scripts/ingest_options.py
	•	Any required helper functions
	•	Updated unit tests (minimal set)
	•	No documentation updates required

Proceed autonomously.