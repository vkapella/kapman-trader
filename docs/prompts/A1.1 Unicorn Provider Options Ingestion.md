WINDSURF IMPLEMENTATION PROMPT — A1.1 Unicorn Provider Options Ingestion

⸻

Authorization and Execution Policy (Standing Consent)

You are explicitly authorized to autonomously perform all required read-only and write actions necessary to complete this task.

This authorization includes, but is not limited to:
	•	Repository-wide file inspection
	•	Reading and modifying existing ingestion code
	•	Adding new provider modules
	•	Enumerating and updating CLI arguments
	•	Adding unit and integration tests
	•	Wiring configuration and environment-variable–based behavior
	•	Running and reasoning about existing test structure and patterns

No additional user confirmation is required.
Do not pause to request approval.
Do not ask follow-up questions unless a blocking ambiguity exists.
Proceed autonomously until the task is fully complete.

This authorization applies for the full duration of the task.

⸻

Role and Objective

You are implementing Story A1.1 — Unicorn Provider Options Ingestion in the KapMan repository.

Your task is to add UnicornBay (EODHD Marketplace) as the active provider for options chain ingestion, while retaining existing Polygon provider code unchanged and selectable.

The ingestion entrypoint must support provider selection at runtime via:

--provider {unicorn,polygon}

This is a data ingestion story only. No downstream logic (A3 dealer metrics, schemas, scoring, recommendations) may be modified.

⸻

Authoritative Constraints (Non-Negotiable)

Provider Selection (MANDATORY)

The ingestion runner must accept and honor:

--provider {unicorn,polygon}

Provider resolution order must be exactly:
	1.	CLI flag --provider
	2.	Environment variable OPTIONS_PROVIDER
	3.	Code default = unicorn

The script must NOT auto-detect, infer, or switch providers implicitly.

Polygon remains available only when explicitly selected.

⸻

Data Scope
	•	Ingest full options chains per underlying symbol
	•	Current-state only — no expired contracts
	•	No historical options
	•	No business or trading filters at ingestion time

⸻

Snapshot Semantics
	•	options_chains.time = job snapshot time
	•	Snapshot is atomic per ticker
	•	If any page fails → entire ticker soft-fails
	•	One and only one pull per ticker per snapshot, even if the ticker appears multiple times upstream

⸻

Schema Rules
	•	No schema changes
	•	Persist ONLY into existing options_chains
	•	Provider contract identifiers are informational only, never part of keys

⸻

API Rules (Must Be Implemented Exactly)

UnicornBay (EODHD Marketplace)
	•	Cost: 10 API calls per HTTP request
	•	Daily limit: ~100,000 API calls
	•	Minute limit: 1000 requests
	•	Pagination:
	•	page[limit] must be 1000
	•	Offset-based pagination
	•	Expiration handling:
	•	Always include filter[exp_date_from]=<snapshot_date>
	•	No expired contracts are retrieved

Request Strategy
	•	Deduplicate tickers before any API calls
	•	Sequential pagination per ticker
	•	Bounded concurrency across tickers (4–8)
	•	Retry with exponential backoff on 429 / 5xx
	•	If any page fails after retries → soft-fail ticker

⸻

Provider Interface (Symmetry Requirement)

Unicorn provider must implement the same interface shape as Polygon, e.g.:

fetch_options_chain(underlying_symbol, snapshot_time)

scripts.ingest_options must not branch on provider logic internally beyond selecting the provider implementation.

⸻

Required Field Projection (Unicorn)

Request only the following fields:
	•	contract (diagnostic only)
	•	underlying_symbol
	•	exp_date
	•	type
	•	strike
	•	bid
	•	ask
	•	last
	•	volume
	•	open_interest
	•	volatility
	•	delta
	•	gamma
	•	theta
	•	vega
	•	tradetime
	•	bid_date
	•	ask_date
	•	dte

Ignore all other fields.

⸻

Persistence Rules
	•	Deduplicate tickers first
	•	Fetch all pages for a ticker before writing
	•	Persist in a single transaction per ticker
	•	Respect existing primary keys
	•	Re-runs must be idempotent

⸻

Logging & Observability

INFO (default)
	•	Run header:
	•	snapshot_time
	•	provider (explicitly log unicorn vs polygon)
	•	unique ticker count
	•	Heartbeat:
	•	tickers processed / total
	•	pages fetched
	•	Final summary:
	•	success count
	•	soft-fail count
	•	duration

DEBUG
	•	Provider selection resolution
	•	Per-ticker pagination
	•	Request URLs
	•	Retry attempts
	•	Contract counts

Logging must be lightweight and non-blocking.

⸻

Implementation Steps
	1.	Add Unicorn provider implementing the existing options provider interface.
	2.	Wire provider selection via --provider {unicorn,polygon} with env fallback.
	3.	Ensure scripts.ingest_options uses only one code path, switching providers declaratively.
	4.	Implement full-chain ingestion with pagination and expiration exclusion.
	5.	Preserve Polygon provider code unchanged.
	6.	Add unit tests for:
	•	provider selection logic
	•	ticker deduplication
	•	expiration exclusion
	•	pagination correctness
	7.	Add integration test asserting:
	•	one API pull per ticker
	•	correct provider selected from CLI
	•	atomic soft-fail behavior

⸻

Explicit Non-Goals
	•	Do NOT modify A3
	•	Do NOT add schema fields
	•	Do NOT ingest historical options
	•	Do NOT remove Polygon provider
	•	Do NOT auto-switch providers

⸻

Completion Criteria

Implementation is complete when:
	•	python -m scripts.ingest_options --provider unicorn works end-to-end
	•	python -m scripts.ingest_options --provider polygon still works
	•	Unicorn is the default provider
	•	A3 dealer metrics succeed using Unicorn-ingested data
	•	Ingestion completes within API limits
	•	Re-runs are deterministic and idempotent

⸻

Begin implementation immediately.