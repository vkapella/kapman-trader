WINDSURF / CODEX — SINGLE FILE PROMPT
MODEL: GPT-5.1-Codex-Mini (medium)

You are acting as a senior backend engineer working in the kapman-trader repository.

You are authorized to:
	•	Read all repository files
	•	Modify existing code
	•	Add or update tests
	•	Run repository-local reasoning autonomously

Do NOT ask clarifying questions.
Do NOT introduce new architecture.
Do NOT change schemas.
Do NOT redefine metric semantics.

Your task is to implement the GitHub story [A8] Refactor Dealer Metrics to Remove Bid/Ask Dependencies (Pricing Optional) exactly as specified below.

⸻

STORY CONTEXT (AUTHORITATIVE)

Owner: @vkapella
Roadmap Reference: S-MET-03 (new) / supports S-MET-02
Scope: A3 dealer metrics job only

Summary:
Refactor the dealer metrics computation pipeline so that option bid/ask pricing is fully optional. Bid/ask columns may remain in the schema and may be NULL. Dealer metrics must compute deterministically using pricing-free inputs (OI, gamma, strike, DTE, option type, spot). Pricing fields are treated strictly as optional enrichment.

⸻

HARD REQUIREMENTS (NON-NEGOTIABLE)
	1.	The A3 dealer-metrics job MUST run successfully when:
	•	options_chains.bid IS NULL
	•	options_chains.ask IS NULL
	•	for all option rows
	2.	Any spread-based filtering:
	•	MUST be applied ONLY if bid AND ask are both present and valid
	•	MUST be skipped if pricing is missing
	•	MUST log at DEBUG when skipped
	•	MUST NOT emit WARN or ERROR due to missing pricing
	3.	Dealer metric definitions MUST NOT change:
	•	GEX, walls, gamma flip, regime, slope, confidence logic remain mathematically identical
	•	No “proxy”, no re-normalization, no semantic changes
	4.	Schema MUST remain unchanged.
	•	Bid/ask columns remain
	•	NULL bid/ask is explicitly allowed
	5.	Determinism and idempotency MUST be preserved.

⸻

FILES IN SCOPE (DISCOVER FROM REPO)

You must locate and modify the existing A3 dealer-metrics implementation, including but not limited to:
	•	Dealer metrics calculation logic
	•	Contract eligibility filters
	•	Spread / liquidity filtering code paths
	•	Dealer metrics JSON assembly
	•	Logging related to filtering and eligibility

Do NOT modify A1 ingestion or A4 volatility metrics.

⸻

IMPLEMENTATION INSTRUCTIONS

A. Pricing Optionality

Identify every place where bid, ask, mid, or spread_pct is referenced.

Refactor so that:
	•	spread_pct is computed ONLY when bid and ask are both non-null and bid > 0
	•	any code path that would error on None is made safe
	•	missing pricing NEVER marks a ticker invalid

If pricing is missing:
	•	Spread filtering becomes a NO-OP
	•	Metrics compute as usual

⸻

B. Metadata Flags (REQUIRED)

Extend the dealer_metrics_json output to include:

metadata:
	•	pricing_available: boolean
→ true if at least one eligible contract had both bid and ask
	•	spread_filter_applied: boolean
→ true only if spread filtering actually ran

These flags must be deterministic and auditable.

⸻

C. Logging Rules
	•	Use existing logging framework
	•	Do NOT print to stdout
	•	When pricing is missing and spread filter is skipped:
	•	DEBUG once per ticker:
“spread filter skipped: pricing missing”
	•	Do NOT WARN or ERROR due to missing bid/ask

⸻

D. CLI Compatibility

The existing CLI flag:
–max-spread-pct

MUST remain accepted.

Behavior change:
	•	If pricing is missing, the flag is ignored silently (DEBUG log only)
	•	If pricing is present, behavior is unchanged

Do NOT add new CLI flags.

⸻

E. Tests (MANDATORY)

Update or add unit tests under:
tests/unit/dealer_metrics/

You MUST add or adjust tests to cover:
	1.	test_spread_filter_skipped_when_pricing_missing
	•	bid=None, ask=None → contracts not filtered
	2.	test_spread_filter_applied_when_pricing_present
	•	wide spread → deterministic exclusion
	3.	test_metrics_compute_with_null_bid_ask
	•	gex_total, gex_net populated with NULL pricing
	4.	test_metadata_pricing_flags
	•	pricing_available false when all pricing missing
	•	spread_filter_applied false when skipped

Tests MUST:
	•	Run under default pytest invocation
	•	Require no special flags
	•	Not depend on external services

If an integration test is trivial to add using existing harnesses, you may add ONE minimal integration test; otherwise, unit tests are sufficient.

⸻

F. Explicit Non-Goals (DO NOT DO)
	•	Do NOT add Black-Scholes pricing
	•	Do NOT reconstruct implied mids
	•	Do NOT alter GEX math
	•	Do NOT refactor ingestion
	•	Do NOT change schemas
	•	Do NOT introduce new abstractions

⸻

DELIVERABLES

Your output must consist of:
	•	Modified A3 dealer-metrics code implementing pricing-optional behavior
	•	Updated / added unit tests passing under pytest
	•	No unrelated refactors
	•	No documentation changes

When finished:
	•	Ensure all tests pass
	•	Ensure code paths with NULL bid/ask execute cleanly
	•	Ensure metadata flags are present and correct

Proceed autonomously until the task is fully complete.