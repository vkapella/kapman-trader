üöÄ WINDSURF CODEX PROMPT ‚Äî Experiment: Qualified AR Entry

You are working in an existing repository that already contains a validated Wyckoff research baseline.

Your task is to implement Experiment 1: Qualified AR Entry in a way that is fully isolated from baseline logic, reproducible, and directly comparable to existing benchmark results.

‚ö†Ô∏è CRITICAL CONSTRAINTS (NON-NEGOTIABLE)
	‚Ä¢	DO NOT modify baseline detector code
	‚Ä¢	DO NOT modify benchmark math
	‚Ä¢	DO NOT redefine AR, SC, or SPRING
	‚Ä¢	DO NOT change horizons (5 / 10 / 20 / 40)
	‚Ä¢	DO NOT add new events
	‚Ä¢	DO NOT look ahead in time
	‚Ä¢	DO NOT overwrite baseline outputs

This is a post-hoc experiment only.

‚∏ª

CONTEXT (EXISTING ARTIFACTS)

Baseline artifacts already exist and are trusted:

docs/research/wyckoff_algo/outputs/
‚îú‚îÄ‚îÄ events.parquet
‚îú‚îÄ‚îÄ events.csv
‚îú‚îÄ‚îÄ events_timeline.csv
‚îú‚îÄ‚îÄ benchmark_results.parquet
‚îî‚îÄ‚îÄ benchmark_results.csv

OHLCV data is available via the dev Postgres database using:

DATABASE_URL=postgresql://kapman:kapman123@127.0.0.1:5432/kapman

Watchlist is fixed at:

docs/research/wyckoff_algo/data/watchlist_105.txt


‚∏ª

OBJECTIVE

Create an isolated experiment that surfaces higher-quality AR entry signals by qualifying AR events with prior Wyckoff structure and a basic volatility regime check, without changing detection logic.

The experiment must produce:
	‚Ä¢	A filtered event stream
	‚Ä¢	A benchmark result that can be compared 1:1 with baseline

‚∏ª

EXPERIMENT DEFINITION ‚Äî Qualified AR Entry

An AR event is kept only if all conditions below are true:

Structural Qualification
	‚Ä¢	The AR is preceded by either:
	‚Ä¢	SC, or
	‚Ä¢	SPRING
	‚Ä¢	Occurring within the prior N bars
	‚Ä¢	Default: N = 20

Volatility Qualification
	‚Ä¢	At the AR bar:
	‚Ä¢	ATR percentile ‚â• 50th percentile
	‚Ä¢	(ATR computed from OHLCV, rolling window acceptable)

Trade Interpretation
	‚Ä¢	Direction remains UP
	‚Ä¢	Role remains ENTRY
	‚Ä¢	Entry timing remains at the AR bar

No other events are emitted.

‚∏ª

REQUIRED FILES TO CREATE

Create a new experiment folder:

docs/research/wyckoff_algo/experiments/exp_qualified_ar/
‚îú‚îÄ‚îÄ run.py
‚îú‚îÄ‚îÄ filter.py
‚îú‚îÄ‚îÄ config.yaml
‚îî‚îÄ‚îÄ README.md


‚∏ª

FILE RESPONSIBILITIES

‚∏ª

config.yaml

Must define:

experiment_id: exp_qualified_ar_v1

lookback_bars: 20
atr_lookback: 14
atr_percentile_min: 50

source_events: ../../outputs/events.parquet
watchlist: ../../data/watchlist_105.txt

No hard-coded constants elsewhere.

‚∏ª

filter.py

Implement:

def apply_experiment(
    events_df: pd.DataFrame,
    ohlcv_by_symbol: dict[str, pd.DataFrame],
    config: dict
) -> pd.DataFrame:
    """
    Returns a filtered subset of events_df.
    Only AR events that satisfy:
      - prior SC or SPRING within lookback window
      - ATR percentile >= threshold
    """

Rules:
	‚Ä¢	Input is baseline events.parquet
	‚Ä¢	Output rows are a subset of AR rows only
	‚Ä¢	No new timestamps
	‚Ä¢	No mutation of baseline data
	‚Ä¢	Must preserve:
	‚Ä¢	symbol
	‚Ä¢	event
	‚Ä¢	direction
	‚Ä¢	role
	‚Ä¢	event_date
	‚Ä¢	bar_index
	‚Ä¢	Add column:
	‚Ä¢	experiment_id

‚∏ª

run.py

Responsibilities:
	1.	Load baseline events from events.parquet
	2.	Load OHLCV via the existing dev DB loader
	3.	Apply apply_experiment
	4.	Write outputs:

docs/research/wyckoff_algo/outputs/exp_qualified_ar/
‚îú‚îÄ‚îÄ events.parquet
‚îú‚îÄ‚îÄ events.csv

CSV must be human-inspectable and sorted by:

symbol, event_date


‚∏ª

README.md

Briefly document:
	‚Ä¢	What Qualified AR Entry means
	‚Ä¢	Why it exists
	‚Ä¢	How it differs from baseline
	‚Ä¢	How to run it

No theory essay ‚Äî concise and factual.

‚∏ª

BENCHMARKING (REUSE, DO NOT MODIFY)

After experiment output is written:
	‚Ä¢	Reuse the existing benchmark runner
	‚Ä¢	Point it at:

outputs/exp_qualified_ar/events.parquet


	‚Ä¢	Produce:

outputs/exp_qualified_ar/benchmark_results.parquet
outputs/exp_qualified_ar/benchmark_results.csv

Benchmark math and horizons must be unchanged.

‚∏ª

ACCEPTANCE CRITERIA (ALL REQUIRED)
	‚Ä¢	Baseline detector untouched
	‚Ä¢	Baseline events.parquet unchanged
	‚Ä¢	Qualified AR produces fewer signals than baseline AR
	‚Ä¢	MAE improves vs baseline AR
	‚Ä¢	Mean return is equal or better at 20 / 40 bars
	‚Ä¢	Outputs are deterministic
	‚Ä¢	Results can be directly diffed against baseline

‚∏ª

DEFINITION OF DONE

This experiment is complete when:

A filtered AR-only event stream has been produced, benchmarked, and shown to improve reliability (MAE) without sacrificing structural integrity or baseline comparability.

‚∏ª

FINAL INSTRUCTION

Do not generalize, refactor, or ‚Äúoptimize.‚Äù
This experiment exists to learn, not to impress.

Proceed carefully and conservatively.

‚∏ª
