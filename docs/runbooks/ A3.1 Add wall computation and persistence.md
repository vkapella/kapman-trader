Understood. We’ll create A3.1 – Add Wall Computation & Persistence using the same disciplined “story wizard” approach you’ve been using for A3/A8. I’ll walk you through it step-by-step, and at the end you’ll have clean, copy-paste–ready story text suitable for GitHub/Jira.

I will not assume any bid/ask usage and will explicitly anchor this to the post-A8 invariants.

⸻

STORY WIZARD — A3.1

[A3.1] Add Wall Computation & Persistence

⸻

Step 1 — Story Identity

Story ID: A3.1
Title: Add Wall Computation & Persistence
Parent Story: A3 – Dealer Metrics Computation
Depends On:
	•	A3 (Dealer metrics core computation & persistence)
	•	A8 (Bid/ask removal; spread-free eligibility model)

Story Type: Feature / Metric Extension
Risk Level: Medium (math + JSON contract evolution)

⸻

Step 2 — Problem Statement (Why this story exists)

Dealer metrics currently compute aggregate gamma context (GEX total, net GEX, gamma flip), but do not expose strike-level structural anchors used by professional options desks:
	•	Call walls
	•	Put walls
	•	Primary call wall
	•	Primary put wall

Without these:
	•	Gamma context lacks price-level localization
	•	Wyckoff + dealer overlays cannot reason about support/resistance mechanics
	•	Entry/exit logic cannot distinguish pinning vs acceleration regimes

This story adds deterministic wall computation and persists results into dealer_metrics_json.

⸻

Step 3 — Explicit Scope (What this story WILL do)

✅ In Scope
	1.	Compute strike-level walls
	•	Call walls (top N by absolute call GEX or OI-weighted gamma)
	•	Put walls (top N by absolute put GEX or OI-weighted gamma)
	2.	Identify primary walls
	•	primary_call_wall
	•	primary_put_wall
	3.	Persist results
	•	Stored inside daily_snapshots.dealer_metrics_json
	•	No schema change required
	4.	Honor A8 invariants
	•	❌ No bid / ask usage
	•	❌ No spread-based filtering
	•	✅ Gamma + OI + strike only
	5.	Deterministic results
	•	Same inputs → same walls
	•	Stable sorting & tie-breaking

⸻

Step 4 — Explicit Non-Goals (Guardrails)

❌ Do NOT:
	•	Use bid, ask, mid, or spread
	•	Introduce new CLI flags
	•	Change existing dealer metrics definitions
	•	Alter status classification logic (FULL / LIMITED / INVALID)
	•	Add visualization or dashboard changes

This story is pure computation + persistence.

⸻

Step 5 — Data Model (JSON Contract)

New Fields in dealer_metrics_json

{
  "call_walls": [
    {
      "strike": 200,
      "gex": 125000000,
      "open_interest": 18234,
      "contracts": 412
    }
  ],
  "put_walls": [
    {
      "strike": 180,
      "gex": -142000000,
      "open_interest": 20111,
      "contracts": 389
    }
  ],
  "primary_call_wall": {
    "strike": 200,
    "gex": 125000000
  },
  "primary_put_wall": {
    "strike": 180,
    "gex": -142000000
  }
}

Notes
	•	contracts = number of option contracts contributing at that strike
	•	Sorting is absolute GEX descending
	•	Primary wall = first entry of sorted list

⸻

Step 6 — Computation Rules (Authoritative)

Eligibility

Reuse existing A3 eligibility filters:
	•	Max DTE
	•	Min OI
	•	Min volume
	•	Missing gamma exclusion

No new filters.

⸻

Wall Aggregation Logic

Per ticker:
	1.	Group eligible options by:
	•	strike
	•	option_type (CALL / PUT)
	2.	Aggregate per strike:
	•	gex = SUM(contract_gex)
	•	open_interest = SUM(oi)
	•	contracts = COUNT(*)
	3.	Rank:
	•	Calls: sort by ABS(gex) descending
	•	Puts: sort by ABS(gex) descending
	4.	Select:
	•	Top walls_top_n → call_walls, put_walls
	•	First element → primary wall

⸻

Step 7 — Persistence Rules
	•	Embed results under dealer_metrics_json
	•	Always present keys:
	•	If no walls → empty arrays
	•	Primary walls = null if unavailable
	•	Do not affect:
	•	processing_status
	•	confidence
	•	status_reason

⸻

Step 8 — Acceptance Criteria (Binary)

✅ For a FULL ticker:
	•	call_walls exists (array)
	•	put_walls exists (array)
	•	primary_call_wall exists or null
	•	primary_put_wall exists or null

✅ No references to bid/ask anywhere in code or JSON

✅ Deterministic output verified by re-run

⸻

Step 9 — Testing Strategy

Unit Tests

Location:

tests/unit/dealer_metrics/

Tests must validate:
	•	Correct aggregation per strike
	•	Correct sorting by absolute GEX
	•	Correct primary wall selection
	•	Empty / edge cases

Integration Test
	•	Run A3 → verify walls persisted in daily_snapshots
	•	Validate dashboard query shows populated wall fields

⸻

Step 10 — Definition of Done
	•	Wall computation implemented
	•	JSON contract extended
	•	Unit tests passing
	•	Integration test run
	•	Dealer metrics dashboard shows wall presence
	•	No bid/ask references remain

⸻