Below is a complete, clean GitHub story you can copy directly into /docs/stories/ and open as an issue.

⸻

[A1.1] Options Chain Historical Backfill & Range Ingestion

Owner: @vkapella
Roadmap Reference: S-MET-02
Dependencies: A1 Options Chain Ingestion, A3 Dealer Metrics
Status: Proposed

⸻

Summary

Extend the existing A1 options chain ingestion pipeline to support deterministic historical backfill across a date range using --start-date and --end-date. This enables reliable reconstruction of missing option snapshots required by downstream dealer-metrics computation, without requiring repeated manual single-day invocations.

The solution must reuse existing ingestion logic, preserve snapshot identity semantics, respect rate limits, and remain idempotent.

⸻

Why This Exists

Dealer metrics require multiple consecutive daily option snapshots to compute stable GEX, walls, and flip signals. Today:
	•	Missing days cause dealer metrics to fail or downgrade confidence
	•	Backfilling requires error-prone manual loops (--as-of per day)
	•	There is no canonical, auditable way to fill gaps in historical options data
	•	Rate limits make ad-hoc retries unreliable on large symbols

This story formalizes range-based backfill as a first-class capability of A1.

⸻

Explicit Deliverables
	1.	Range ingestion mode via CLI:
	•	--start-date YYYY-MM-DD
	•	--end-date YYYY-MM-DD (inclusive)
	2.	For each trading day in the range:
	•	Invoke existing single-day ingestion logic using that day as as_of
	•	Generate a distinct snapshot identity per day
	3.	Automatic skipping of days that already have a completed snapshot
	4.	Consistent logging, heartbeat, and summary output aligned with other pipelines
	5.	No schema changes

⸻

Explicit Non-Goals
	•	No changes to dealer-metrics math
	•	No provider-specific backfill logic
	•	No calendar service integration
	•	No schema or index changes
	•	No parallelization across days (days are processed sequentially)

⸻

CLI Contract

New Flags

--start-date YYYY-MM-DD   # Start date for historical backfill (inclusive)
--end-date YYYY-MM-DD     # End date for historical backfill (inclusive)

Valid Invocation Modes

Mode	Behavior
--as-of only	Existing single-day ingestion
--start-date + --end-date	Range backfill (new)
Neither	Default: today

Validation Rules
	•	--start-date requires --end-date
	•	--end-date must be >= --start-date
	•	--as-of cannot be combined with range flags

⸻

Inputs, Outputs, and Invariants

Tables Read
	•	public.watchlists
	•	public.tickers
	•	public.options_chains

Tables Written
	•	public.options_chains

Invariants
	•	Deterministic: same DB state + params → same rows
	•	Idempotent: reruns skip already-ingested (date, symbol) pairs
	•	One snapshot per trading day
	•	Snapshot identity = (time, ticker_id, expiration_date, strike, option_type)

⸻

Data Flow & Control Flow

High-Level Flow
	1.	Parse CLI arguments
	2.	Resolve ingestion mode:
	•	Single-day or range
	3.	If range mode:
	•	Expand [start_date, end_date] into daily dates
	•	Exclude weekends automatically
	4.	For each date sequentially:
	•	Resolve effective as_of date
	•	Generate snapshot_time (default: now UTC)
	•	Load active watchlist symbols
	•	Skip symbols already completed for that date
	•	Ingest remaining symbols using existing A1 logic
	5.	Aggregate per-day results into a final run report

⸻

Failure Modes & Idempotency

Expected Failures (Non-Fatal)
	•	Provider timeout for a symbol → logged, continues
	•	No contracts returned for a symbol → recorded as failed symbol
	•	Missing ticker_id → existing behavior

Idempotency
	•	Symbol-level completion is tracked per (symbol, snapshot_time)
	•	Re-running the same range will skip completed symbols and dates

⸻

Logging & Observability

Logging Levels
	•	INFO:
	•	Start/end of run
	•	Per-day summary
	•	Final aggregate summary
	•	DEBUG:
	•	Per-symbol skip reasons
	•	Rate-limit sleeps
	•	WARN:
	•	Provider timeouts
	•	ERROR:
	•	Unexpected exceptions only

Heartbeat
	•	Reuse existing --heartbeat semantics
	•	Heartbeat emitted per N symbols per day

⸻

Testing Strategy

Unit Tests

Add tests under tests/unit/options/:
	1.	test_range_expands_trading_days_only
	2.	test_range_rejects_invalid_combinations
	3.	test_range_skips_completed_days
	4.	test_single_day_path_unchanged

All tests must pass under default pytest.

Integration Tests (Optional)
	•	If harness exists, validate two-day range ingestion produces two snapshot times.

⸻

Acceptance Criteria
	•	Running:

python -m scripts.ingest_options \
  --provider polygon \
  --start-date 2025-12-15 \
  --end-date 2025-12-22

produces one snapshot per trading day

	•	Re-running the same command produces zero duplicate rows
	•	Dealer metrics can compute successfully once range is filled
	•	No schema or provider changes required

⸻

Implementation Notes (Checklist)
	•	Reuse existing single-day ingestion function
	•	Add a thin date-loop wrapper
	•	Skip weekends via weekday() < 5
	•	Ensure snapshot_time uniqueness per run
	•	Preserve rate-limiting and large-symbol handling
	•	Do not parallelize across dates

⸻

End of Story