[A2.1] Local TA + Price Metrics — Chunked Execution (Single-Process)

**Issue ID:** A2.1  
**Roadmap Ref:** S-MET-03 (continuation)  
**Owner:** @vkapella  
**Status:** Ready for implementation

---

## Objective

Improve A2 runtime performance by introducing deterministic, single-process ticker chunking. This establishes predictable units of work, improves cache locality, and provides ground truth metrics for future parallel execution.

Expected improvement: **10–20%**.

---

## Scope

### In Scope
- Add `--ticker-chunk-size N` CLI flag
- Process tickers in fixed-size batches
- Emit per-chunk timing and ETA metrics
- Preserve full determinism and idempotency

### Out of Scope
- Parallelism
- Indicator changes
- Schema changes
- Watchlist scoping
- Adaptive chunk sizing

---

## Inputs

### Tables Read
- `tickers` (active tickers)
- `ohlcv` (historical daily bars)

### Invocation Flags
- `--date`
- `--start-date / --end-date`
- `--fill-missing`
- `--ticker-chunk-size N` *(new)*

---

## Outputs

### Tables Written
- `daily_snapshots` (unchanged semantics)

### Logs
- Run configuration header
- Per-chunk DEBUG telemetry
- Periodic INFO heartbeat with ETA
- Final summary

---

## Default Chunk Size

- **System default:** `500`
- Encoded statically based on current dataset (~10k tickers)
- Logged clearly at startup
- Always overridable via CLI

---

## Execution Flow

for date in snapshot_dates:
tickers = resolve_active_tickers()
chunks = partition(tickers, chunk_size)
for chunk in chunks:
start timer
load OHLCV for chunk
compute indicators
write snapshots
stop timer
update ETA
log telemetry

---

## ETA Calculation

After each chunk:

avg_time_per_ticker = elapsed_compute_time / processed_tickers
eta_remaining_sec = avg_time_per_ticker × remaining_tickers

---

## Failure & Idempotency

- Indicator failures → NULL values
- Chunk failures → abort run, partial progress preserved
- Reruns are safe due to `(time, ticker_id)` upserts
- Chunk size does not affect correctness

---

## Testing

### Unit Tests
- Chunk partitioning
- Default chunk size behavior
- ETA math (float tolerance)
- Telemetry fields

### Integration Tests
- Same results with different chunk sizes
- Idempotence preserved
- Compare deterministic sample of tickers

---

## Operational Notes

- Chunking is transparent to operators
- Logs provide real-time progress and ETA
- Summary metrics guide future scaling decisions

---

## Follow-On Work
- **A2.2** — Parallel chunk execution
- **A2.3** — Vectorized / pre-aggregated indicator paths


⸻

If you want, next we can:
	•	Convert this directly into a Windsurf execution prompt
	•	Draft A2.2 parallelism while numbers are fresh
	•	Or benchmark expected prod runtimes based on current telemetry