You are working inside the KapMan repository.

GOAL
-----
Create a new Wyckoff experiment named:

    exp_spring_to_sos_entry_v1

This experiment tests whether an SOS entry is more reliable when preceded by a SPRING event within a reasonable Wyckoff window.

This is a RESEARCH experiment. Do NOT modify raw detectors, benchmark math, or baseline code.

DIRECTORY
---------
Create the following directory:

docs/research/wyckoff_algo/experiments/exp_spring_to_sos_entry_v1/

FILES TO CREATE
---------------

1) config.yaml
2) filter.py
3) run.py

You may copy and adapt patterns from:
- experiments/exp_ar_to_sos_entry_v1
- experiments/exp_qualified_ar_v1

Do NOT modify files outside this experiment directory.

--------------------------------------------------
1) config.yaml
--------------------------------------------------

Create config.yaml with these semantics:

experiment_id: exp_spring_to_sos_entry_v1

# Source raw detected events
source_events: ../../outputs/raw/events.parquet

# Spring → SOS sequencing rules
spring_to_sos_max_bars: 60
use_bc_invalidator: true

# Benchmark horizons are unchanged (handled by benchmark runner)

--------------------------------------------------
2) filter.py
--------------------------------------------------

Implement apply_experiment(events_df, ohlcv_by_symbol, cfg):

Behavior:
- Process events symbol-by-symbol
- Preserve the FULL SOS event row (do not re-label or mutate core fields)
- Emit an SOS event only if:
    a) There exists a SPRING event for the same symbol
    b) The SPRING occurs BEFORE the SOS
    c) The SPRING is within spring_to_sos_max_bars bars of the SOS
    d) If use_bc_invalidator is true, reject the SOS if a BC occurs
       between the SPRING and the SOS

Implementation requirements:
- Use bar_index ordering (fallback to event_date if missing)
- Do NOT drop columns like symbol/ticker
- Do NOT assume column names — preserve schema
- Add ONLY these optional metadata columns:
    matched_spring_bar_index
    matched_spring_date
    bars_since_spring

Return a DataFrame of accepted SOS events.

--------------------------------------------------
3) run.py
--------------------------------------------------

Create run.py by copying the *working* run.py from exp_ar_to_sos_entry_v1 and adapting only:

- OUTPUT_DIR to:
    outputs/exp_spring_to_sos_entry_v1

- Logging string:
    "Applying SPRING -> SOS experiment filter."

STRICT REQUIREMENTS:
- Use dynamic identifier resolution (symbol vs ticker)
- Call load_ohlcv() with NO arguments
- Write outputs named with experiment_id:
    events_<experiment_id>.parquet
    events_<experiment_id>.csv
    benchmark_results_<experiment_id>.parquet
    benchmark_results_<experiment_id>.csv
- If no events are produced, log a WARNING and exit cleanly

DO NOT:
- Hard-code "symbol"
- Change benchmark math
- Change raw event detection
- Change load_ohlcv()

--------------------------------------------------
EXPECTED RESULT
--------------------------------------------------

After running:

python docs/research/wyckoff_algo/experiments/exp_spring_to_sos_entry_v1/run.py

We should get:

docs/research/wyckoff_algo/outputs/exp_spring_to_sos_entry_v1/
    events_exp_spring_to_sos_entry_v1.csv
    events_exp_spring_to_sos_entry_v1.parquet
    benchmark_results_exp_spring_to_sos_entry_v1.csv
    benchmark_results_exp_spring_to_sos_entry_v1.parquet

The experiment should produce NON-ZERO events unless SPRING→SOS
is genuinely rare in the raw dataset.

--------------------------------------------------
QUALITY BAR
--------------------------------------------------

- Preserve schema integrity
- Deterministic output
- No side effects
- Research-grade clarity

Proceed step by step and generate all files completely.