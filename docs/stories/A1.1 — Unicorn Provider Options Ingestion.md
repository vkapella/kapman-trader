A1.1 — Unicorn Provider Options Ingestion

Status: Planned
Owner: KapMan
Roadmap Reference: A1
Related Stories: A3 (Dealer Metrics Computation & Persistence)
Scope Classification: Data ingestion (provider swap, no downstream logic changes)

⸻

1. Intent & Purpose

This story introduces UnicornBay (EODHD Marketplace) as the authoritative provider for current-state options chain data. It replaces Polygon/Massive S3 as the active options source while retaining existing Polygon provider code for symmetry and fallback, without using it by default.

The objective is to ingest complete, non-expired option chains per underlying in a deterministic, cost-aware, provider-symmetric manner so downstream consumers (notably A3 dealer metrics) receive complete and high-quality data.

⸻

2. Explicit In-Scope / Out-of-Scope

In Scope
	•	Full-chain options ingestion per underlying using UnicornBay API
	•	Current-state options only (non-expired)
	•	Atomic, per-ticker snapshot ingestion
	•	Deduplication of tickers per snapshot
	•	Provider interface symmetry with existing Polygon provider
	•	Persistence into existing options_chains schema
	•	Cost- and rate-limit–aware pagination and batching
	•	Soft-fail handling per ticker

Out of Scope
	•	Schema changes
	•	Historical options ingestion
	•	Business or trading filters (DTE, OI, volume, spreads)
	•	Changes to A3 logic or downstream consumers
	•	Removal of Polygon provider code

⸻

3. Authoritative Data Source
	•	Provider: UnicornBay (EODHD Marketplace)
	•	API Docs: https://eodhd.com/marketplace/unicornbay/options/docs
	•	API Cost Model:
	•	10 API calls per HTTP request
	•	Daily limit: 100,000 API calls
	•	Minute limit: 1,000 requests/min
	•	Pagination:
	•	page[limit] default and max = 1000
	•	page[offset] max = 10,000

⸻

4. Core Invariants (Non-Negotiable)
	1.	One pull per ticker per snapshot
	•	If a ticker appears multiple times in the input set, its options chain is fetched exactly once.
	2.	No expired contracts
	•	Historical/expired options are never ingested.
	•	Enforced at query time via filter[exp_date_from]=snapshot_date.
	3.	Atomic per-ticker snapshot
	•	All pages for a ticker must succeed before any persistence.
	•	Partial chains are not written.
	4.	Provider symmetry
	•	Unicorn provider implements the same interface shape as Polygon.
	5.	No schema changes
	•	Data is mapped into existing options_chains columns only.
	6.	Soft-fail isolation
	•	Failure of one ticker does not abort the run.

⸻

5. Inputs, Outputs, and Tables

Inputs
	•	Watchlist / active tickers (unique underlying symbols)
	•	Snapshot time (job invocation time)

Tables Read
	•	tickers (active symbols)

Tables Written
	•	options_chains

Tables Explicitly Not Touched
	•	ohlcv
	•	daily_snapshots
	•	recommendations

⸻

6. Provider Interface & Data Mapping

Provider Interface (Symmetric with Polygon)

fetch_options_chain(
    underlying_symbol: str,
    snapshot_time: timestamptz
) -> List[OptionContract]

Field Mapping (Unicorn → options_chains)

options_chains column	Unicorn field
time	snapshot_time
ticker_id	resolved from underlying_symbol
expiration_date	exp_date
strike_price	strike
option_type	type
bid	bid
ask	ask
last	last
volume	volume
open_interest	open_interest
implied_volatility	volatility
delta	delta
gamma	gamma
theta	theta
vega	vega
created_at	ingestion timestamp

Unicorn contract identifier is logged as diagnostic metadata only and is not part of any key.

⸻

7. Query & Pagination Strategy

Base Query (per ticker)
	•	filter[underlying_symbol]=<symbol>
	•	filter[exp_date_from]=<snapshot_date>
	•	page[limit]=1000
	•	Explicit fields[options-contracts] projection (only required fields)

Pagination
	•	Sequential pagination per ticker using page[offset]
	•	Follow links.next until exhausted
	•	Offset-based, deterministic ordering

⸻

8. Rate & Cost Control Strategy
	•	Always use page[limit]=1000
	•	Bounded concurrency across tickers (e.g., 4–8 parallel tickers)
	•	Sequential page fetch per ticker
	•	Retry on 429 / 5xx with exponential backoff + jitter
	•	Max retries per page (e.g., 3)
	•	If any page fails after retries → ticker soft-fails

This guarantees:
	•	≤ ~50,000 API calls/day for ~500 tickers
	•	No minute-limit violations
	•	Predictable completion in minutes

⸻

9. Control Flow (Per Snapshot Run)
	1.	Resolve snapshot_time
	2.	Load active tickers
	3.	Deduplicate underlying symbols
	4.	For each ticker (bounded concurrency):
	•	Fetch all pages from Unicorn
	•	If any page fails → soft-fail ticker
	•	Map records to options_chains
	•	Persist all rows in a single transaction
	5.	Log final summary

⸻

10. Idempotency & Persistence
	•	Primary key semantics unchanged
	•	Inserts are idempotent per (time, ticker_id, expiration_date, strike_price, option_type)
	•	Snapshot re-runs overwrite the same logical dataset without duplication

⸻

11. Logging & Observability

Required Logs (INFO default)

Run Header
	•	Snapshot time
	•	Provider = Unicorn
	•	Total unique tickers
	•	Page limit

Heartbeat
	•	Tickers processed / remaining
	•	Pages fetched
	•	API calls consumed (estimated)

Final Summary
	•	Total tickers
	•	Success count
	•	Soft-fail count
	•	Duration

DEBUG (via CLI / config)
	•	Per-ticker pagination
	•	Raw request URLs
	•	Retry attempts
	•	Contract counts

toggleable via standard --log-level flag

⸻

12. Testing Strategy

Unit Tests
	•	Provider pagination logic
	•	Field mapping correctness
	•	Deduplication logic
	•	Expiration filter enforcement

Integration Tests
	•	Mock Unicorn responses
	•	Atomic per-ticker persistence
	•	Soft-fail behavior on partial pagination failure

All tests must be discoverable via default pytest.

⸻

13. Acceptance Criteria
	•	Unicorn provider ingests full, non-expired option chains
	•	Each ticker fetched at most once per snapshot
	•	No expired options present in options_chains
	•	Page size fixed at 1000
	•	Polygon provider code remains intact but inactive
	•	A3 dealer metrics run successfully using Unicorn-ingested data
	•	Ingestion completes within daily API limits

⸻

14. Explicit Non-Goals
	•	No historical backfills
	•	No option analytics
	•	No schema evolution
	•	No downstream refactors

⸻

End of Story: A1.1 — Unicorn Provider Options Ingestion