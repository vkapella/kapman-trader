Windsurf / Codex Prompt

Title: A1 Snapshot Determinism & Same-Day Guardrails

You are working in the kapman-trader repository.

Objective

Formalize daily snapshot determinism for A1 options ingestion and add guardrails to prevent accidental multiple ingests for the same trading day, while preserving backward compatibility.

Dealer metrics (A3) and volatility metrics (A4) must consume exactly one deterministic snapshot per symbol per day.

â¸»

Problem Statement (Context You Must Respect)

Currently:
	â€¢	Multiple ingest_options runs on the same calendar day create multiple time values in options_chains
	â€¢	This leads to:
	â€¢	Inflated contract counts
	â€¢	Dealer metrics ambiguity
	â€¢	Confusing dashboards
	â€¢	Users are backfilling data using --as-of and --start-date / --end-date

We need:
	â€¢	One canonical snapshot_time per trading day
	â€¢	Deterministic behavior across reruns
	â€¢	No schema changes

â¸»

Design Rules (Hard Constraints)
	1.	No schema changes
	2.	Do not delete existing data
	3.	Snapshot identity must be deterministic
	4.	Backfill must be supported
	5.	Dealer metrics must naturally select the correct snapshot
	6.	No breaking CLI behavior

â¸»

Required Behavioral Changes

1ï¸âƒ£ Deterministic Snapshot Time (Core Fix)

Define canonical snapshot_time per trading day as:

snapshot_time = as_of_date at 23:59:59 UTC

Rules:
	â€¢	If --as-of YYYY-MM-DD is provided:
	â€¢	snapshot_time MUST be YYYY-MM-DDT23:59:59Z
	â€¢	If --start-date / --end-date are used:
	â€¢	Each day in the range gets its own deterministic snapshot_time
	â€¢	If neither is provided:
	â€¢	Default to todayâ€™s trading date, same rule

ðŸš« Never use now() for snapshot identity again.

â¸»

2ï¸âƒ£ Guardrail: Prevent Duplicate Same-Day Ingests

Before ingesting a symbol for a given snapshot_time:
	â€¢	Check options_chains for any existing rows for:

(ticker_id, snapshot_time)


	â€¢	If rows exist:
	â€¢	Skip ingestion for that symbol
	â€¢	Log at INFO:

options ingestion skipped (already ingested for snapshot_time)



This applies to:
	â€¢	Single-day runs
	â€¢	Range backfills
	â€¢	Manual reruns

â¸»

3ï¸âƒ£ Range Backfill Behavior (start-date / end-date)

Implement range mode as:

For each date D in [start_date, end_date]:
	1.	Resolve snapshot_time = D @ 23:59:59 UTC
	2.	Run ingestion with:
	â€¢	Normal rate limits
	â€¢	Normal large-symbol serialization
	3.	Skip symbols already ingested for that day

Weekends:
	â€¢	Still allowed (provider may return data or empty)
	â€¢	Do NOT auto-skip weekends
	â€¢	Let provider behavior decide

â¸»

4ï¸âƒ£ Dealer Metrics Compatibility (Critical)

Do not change A3 logic directly.

Ensure that A3 naturally works by:
	â€¢	Having only one snapshot_time per symbol per day
	â€¢	Ensuring snapshot_time is deterministic

(Dealer metrics already select latest snapshot â‰¤ day â€” this will now be unambiguous.)

â¸»

5ï¸âƒ£ Logging & Observability

Add structured logs:

At run start:

A1 ingestion start | mode=range | start=YYYY-MM-DD | end=YYYY-MM-DD

Per date:

A1 snapshot resolved | as_of=YYYY-MM-DD | snapshot_time=...

On skip:

A1 symbol skipped | symbol=NVDA | snapshot_time=... | reason=already_ingested

At end:

A1 ingestion complete | days=N | symbols_ok=X | symbols_skipped=Y

No WARN or ERROR for skips.

â¸»

6ï¸âƒ£ CLI Help Text Updates

Update --snapshot-time help to:

Snapshot identity (ISO-8601). In normal usage this is derived deterministically from --as-of or date range and should not be overridden.


â¸»

Implementation Checklist (Codex Must Do All)
	â€¢	Add helper: resolve_snapshot_time(as_of_date) -> timestamptz
	â€¢	Replace all now() snapshot assignments
	â€¢	Add pre-ingestion existence check per (ticker_id, snapshot_time)
	â€¢	Ensure range mode loops day-by-day
	â€¢	Preserve existing rate limiting & large-symbol isolation
	â€¢	Update unit tests or add minimal new ones:
	â€¢	Deterministic snapshot_time
	â€¢	Skip on re-run same day
	â€¢	Do not touch schema

â¸»

Definition of Done
	â€¢	Running ingest_options 5 times on the same day produces no new rows
	â€¢	Backfilling a date range produces exactly one snapshot per day
	â€¢	Dealer metrics no longer see inflated contract counts
	â€¢	Dashboards show clean per-day coverage
	â€¢	All tests pass

â¸»

Final Instruction

Proceed to implement this exactly.
Do not refactor unrelated code.
Do not add new flags beyond what exists.
Favor clarity over cleverness.

